name: NetBox WAN IP ingest (self-hosted)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours

jobs:
  Ingest_Wan_IPs:
    runs-on: [self-hosted, netbox, internal]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show runner identity + network sanity
        run: |
          whoami
          hostname
          ip a | sed -n '1,120p'
          curl -sS https://api.github.com | head -n 3

      - name: List repo files (verify JSON exists)
        run: |
          ls -la
          find . -maxdepth 3 -type f -name "*.json" -print

      - name: Print first 50 lines of the WAN JSON (adjust path)
        run: |
          sed -n '1,50p' ./data/wan_ips.json

      - name: Setup python + install pynetbox library
        env:
          NETBOX_URL: ${{ secrets.NETBOX_URL }}
          NETBOX_TOKEN: ${{ secrets.NETBOX_TOKEN }}
        run: |
          python3 -V
          python3 -m venv .venv
          . .venv/bin/activate
          python3 -m pip install --upgrade pip
          python3 -m pip install requests
          pip install pynetbox

      - name: Run scripts
        run:
          python3 scripts/netbox_ping.py
          python3 scripts/ingest_wan_ip.py
          python3 scripts/clean_deprecated_wan_ip.py
